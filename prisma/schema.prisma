generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  // Comment out extensions to avoid issues with Prisma Accelerate
  // extensions = [pgvector]
}

/**
 * ===========================
 * Enums
 * ===========================
 */

enum UserRole {
  OWNER
  ADMIN
  MEMBER
}

enum PlanTier {
  STARTER // 1 active slot
  PRO // 2 active slots (future)
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  unpaid
  incomplete
  incomplete_expired
}

enum RequestStatus {
  BACKLOG
  ACTIVE
  REVIEW
  DONE
  PAUSED
  REJECTED
}

enum ActivityType {
  CREATED
  UPDATED
  STATUS_CHANGED
  COMMENT_ADDED
  ATTACHMENT_ADDED
  SYSTEM_EVENT
}

enum CommentVisibility {
  PUBLIC // visible to client/org
  INTERNAL // visible to you/admin only
}

/**
 * ===========================
 * Core Identity / Org
 * ===========================
 */

model User {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  // OIDC subject from Kinde
  authProviderId String  @unique
  email          String  @unique
  name           String?
  avatarUrl      String?

  // preferences
  timeZone String? // e.g. "Europe/Rome"
  locale   String? // e.g. "it-IT"

  memberships     OrgMember[]
  requestsCreated Request[]        @relation("RequestsCreatedBy")
  comments        RequestComment[]
  activities      Activity[]       @relation("ActivitiesBy")

  settings UserSettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([authProviderId])
}

model Org {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  slug            String   @unique
  plan            PlanTier @default(STARTER)
  concurrentSlots Int      @default(1) // overrideable

  // Stripe linkage
  stripeCustomerId String? @unique

  // relations
  members          OrgMember[]
  invites          OrgInvite[]
  subscriptions    Subscription[]
  requests         Request[]
  payments         Payment[]
  activities       Activity[]
  attachments      Attachment[]
  revenueSnapshots RevenueSnapshot[]
  socialSnapshots  SocialSnapshot[]
  bankSnapshots    BankSnapshot[]
  roadmapItems     RoadmapItem[]
  weeklyUpdates    WeeklyUpdate[]
  changelog        ChangelogEntry[]

  settings OrgSettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stripeCustomerId])
}

model OrgMember {
  id     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId  String   @db.Uuid
  userId String   @db.Uuid
  role   UserRole @default(MEMBER)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([orgId, userId])
  @@index([userId])
}

model OrgInvite {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String   @db.Uuid
  email     String
  role      UserRole @default(MEMBER)
  token     String   @unique
  expiresAt DateTime

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  acceptedBy String?   @db.Uuid
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@index([orgId, email])
}

/**
 * ===========================
 * Billing (Stripe Mirror)
 * ===========================
 */

model Subscription {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId                String             @db.Uuid
  stripeSubscriptionId String             @unique
  stripePriceId        String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  paused               Boolean            @default(false) // pause_collection mirror

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([status])
}

model Payment {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId           String    @db.Uuid
  stripeInvoiceId String    @unique
  amountCents     Int
  currency        String    @db.VarChar(3)
  paidAt          DateTime
  periodStart     DateTime?
  periodEnd       DateTime?

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([orgId, paidAt])
}

/**
 * ===========================
 * Request Queue (Client Work)
 * ===========================
 */

model Request {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String        @db.Uuid
  title       String
  description String        @db.Text
  status      RequestStatus @default(BACKLOG)
  priority    Int           @default(3) // 1=high,5=low
  orderIndex  Int           @default(0) // sort within BACKLOG
  previewUrl  String?
  createdById String?       @db.Uuid
  eta         DateTime? // optional SLA target

  org       Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy User? @relation("RequestsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  comments    RequestComment[]
  attachments Attachment[]
  activities  Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Enforce ONE ACTIVE per org via partial unique index in SQL (see bottom)

  @@index([orgId, status])
  @@index([createdById])
}

model RequestComment {
  id         String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requestId  String            @db.Uuid
  authorId   String?           @db.Uuid // null if system
  visibility CommentVisibility @default(PUBLIC)
  body       String            @db.Text

  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  author  User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([requestId])
  @@index([authorId])
}

model Attachment {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId      String  @db.Uuid
  requestId  String? @db.Uuid
  url        String  @db.Text
  kind       String? // "image","doc","link"
  uploadedBy String? @db.Uuid

  org     Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  request Request? @relation(fields: [requestId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([orgId, requestId])
}

/**
 * ===========================
 * Activity / Audit
 * ===========================
 */

model Activity {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String       @db.Uuid
  requestId String?      @db.Uuid
  type      ActivityType
  meta      Json?        @db.JsonB // diff, from->to, etc.
  actorId   String?      @db.Uuid // null = system/webhook

  org     Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  request Request? @relation(fields: [requestId], references: [id], onDelete: SetNull)
  actor   User?    @relation("ActivitiesBy", fields: [actorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([orgId, createdAt])
  @@index([requestId])
  @@index([actorId])
}

/**
 * ===========================
 * Transparency / Reporting
 * ===========================
 */

model RevenueSnapshot {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  snapshotDate DateTime @default(now())
  mrrCents     Int      @default(0)
  allTimeCents Int      @default(0)
  activeSubs   Int      @default(0)

  orgId String? @db.Uuid // null => global
  org   Org?    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([snapshotDate])
  @@index([orgId, snapshotDate])
}

model SocialSnapshot {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  snapshotDate      DateTime @default(now())
  xFollowers        Int      @default(0)
  linkedinFollowers Int      @default(0)

  orgId String? @db.Uuid // keep null (global) unless per-org later
  org   Org?    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([snapshotDate])
}

model BankSnapshot {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  snapshotDate DateTime @default(now())
  balanceCents Int      @default(0)
  currency     String   @default("EUR") @db.VarChar(3)
  source       String   @default("midday") // Midday provider id/name

  createdAt DateTime @default(now())
  Org       Org?     @relation(fields: [orgId], references: [id])
  orgId     String?  @db.Uuid

  @@index([snapshotDate])
}

/**
 * ===========================
 * Roadmap / Updates / Changelog
 * ===========================
 */

model RoadmapItem {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String? @db.Uuid // global roadmap if null
  title     String
  status    String  @default("todo") // "todo" | "in-progress" | "done"
  sortIndex Int     @default(0)
  emoji     String? // "âœ…", "ðŸ”„", "ðŸ”œ"

  org Org? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WeeklyUpdate {
  id     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  weekOf DateTime // Monday of week
  title  String
  body   String   @db.Text
  public Boolean  @default(true)

  orgId String? @db.Uuid
  org   Org?    @relation(fields: [orgId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([weekOf, orgId])
  @@index([weekOf])
}

model ChangelogEntry {
  id     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date   DateTime @default(now())
  title  String
  body   String   @db.Text
  public Boolean  @default(true)

  orgId String? @db.Uuid
  org   Org?    @relation(fields: [orgId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([date])
}

/**
 * ===========================
 * Settings
 * ===========================
 */

model OrgSettings {
  id                  String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId               String  @unique @db.Uuid
  preferredComms      String? // "email" | "slack" | etc.
  slackChannel        String?
  slotOverride        Int? // override concurrent slots if set
  allowPublicExamples Boolean @default(true)

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model UserSettings {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String  @unique @db.Uuid
  notifyOnStatus  Boolean @default(true)
  notifyOnComment Boolean @default(true)
  marketingEmails Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * Webhook Event Log (optional but useful)
 * ===========================
 */

model WebhookEvent {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider   String // "stripe" | "midday" | etc.
  eventType  String
  externalId String? // stripe event id, etc.
  payload    Json    @db.JsonB
  processed  Boolean @default(false)
  error      String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([provider, eventType])
}
